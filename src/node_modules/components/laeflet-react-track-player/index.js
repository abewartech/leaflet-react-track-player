import React from "react"
import moment from "moment";
import L from 'leaflet';
import { MapControl, withLeaflet } from "react-leaflet";
import "./multyPolyline";
import "./snake";
import "./index.css"

class LeafletReactTrackPlayer extends MapControl {
    constructor(props) {
        super(props)
        this.state = {
            activePosition: 0,
            track: [],
            active: true,
        }
    }

    componentDidMount() {
        this.leafletElement.snakePolyline.snakeIn(
            (e, d) => {
                if (e) {
                    this.leafletElement.finishMarker.setLatLng(e);
                }
                this.setState({activePosition: d})
            }, 
            (point) => {
                this.leafletElement.finishMarker.setIcon(this.createIcon(point.course));
            },
            () => this.setState({active: false})
        )
    }

    changeActivePosition = (e) => {
        const coordinates = e.target.getBoundingClientRect();
        const activeX = e.pageX;
        const durationTrack = moment(this.props.track[this.props.track.length - 1].t, "YYMMDDHHmmss000") - moment(this.props.track[0].t, "YYMMDDHHmmss000");
        this.setState({
            activePosition: (activeX - coordinates.left) / (this.line.clientWidth / 100)
        }, () => {
            const activePositionTime = moment(this.props.track[0].t, "YYMMDDHHmmss000").add((durationTrack / 100) * this.state.activePosition, "millisecond");
            this.leafletElement.snakePolyline.changePosition(activePositionTime.format("YYMMDDHHmmss000"));
        })
    }

    tooglePlay = () => {
        this.setState({
            active: !this.state.active,
        }, () => {
            if (this.state.active) {
                this.leafletElement.snakePolyline.snakePlay();
            } else this.leafletElement.snakePolyline.snakeStop();
        })
    }

    createLeafletElement() {
        this.createIcon = (rotate) => L.divIcon({
            html: `<div style="background: url('${this.props.markerIcon}') no-repeat center; height: 100%; transform: rotate(${rotate}deg)"></div>`,
            iconSize: [35, 35],
          })
        const finishMarker = L.marker(this.props.track[0], {icon: this.createIcon(this.props.track[0].course)})
        this.props.leaflet.map.addLayer(finishMarker);
        const snakePolyline = this.props.useMultyPolyline ? 
            L.multiOptionsPolyline(this.props.track, {
                multiOptions: {
                    optionIdxFn: this.props.optionMultyIdxFn,
                    options: this.props.optionsMulty
                },
                snakingSpeed: 20
            }) : L.polyline(this.props.track);
        this.props.leaflet.map.addLayer(snakePolyline);
        return {
            snakePolyline, finishMarker
        }
    }

    render() {
        return (
            <div>
                <div className="leaflet-react-track-player">
                    <div className="tp-buttons">
                        <div className="tp_button prev" />
                        <div className={`tp_button ${this.state.active ? "pause" : "play"}`} onClick={() => this.tooglePlay()} />
                        <div className="tp_button stop" />
                        <div className="tp_button next" />
                    </div>
                    <div className="tp_track-line">
                        <div className="tp_track-line_line" ref={(line) => { this.line = line }} onClick={(e) => this.changeActivePosition(e)}>
                            <div className="tp_track-line_active" style={{ width: `${this.state.activePosition}%` }} />
                        </div>
                    </div>
                </div>
            </div>
        )
    }
}

export default withLeaflet(LeafletReactTrackPlayer);